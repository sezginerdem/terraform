pipeline {
    agent any
    stages {
        stage("Pull Playbook from SCM") {
            steps {
                git 'https://github.com/sezginerdem/ansible'
            }
        }
        
        stage("Assign Variables into the Playbook") {
            steps {
                script {
                    if (params.ADD_USER != ""){
                            sh """sed -i 's/add_user/${ADD_USER}/' playbook_add_user.yml"""
                            sh """sed -i 's/user_group_name/${GROUP_NAME}/' playbook_add_user.yml"""
                            sh """cat > user_public_key.pub <<EOF
                            ${USER_PUBLIC_KEY}
                            """
                    }
                    if(params.REMOVE_USER != ""){
                           sh """sed -i 's/remove_user/${REMOVE_USER}/' playbook_remove_user.yml"""
                    }
                }
            }
        }

        stage("Run Playbook") {
            steps {
                script {
                    if (params.ADD_USER != ""){
                ansiblePlaybook disableHostKeyChecking: true, installation: 'ansible', playbook: './playbook_add_user.yml'
                    }
                }
            
            }
        }
        
        stage("Cleaning Workspace") {
            steps {
                sh 'rm -rf ./*'
            }
        }
    }
}z\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\